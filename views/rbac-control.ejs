<!-- @format -->
<link rel="stylesheet" href="/public/css/rbac-control.css"/>

<div class="main-content p-4">
    <div class="container-fluid">
        <!-- Header -->
        <!-- <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">üîê Manajemen Role & Akses</h2>
                <p class="text-muted">Kelola peran dan hak akses pengguna sistem TUKIN</p>
            </div>
        </div> -->
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-number"><%= stats ? stats.totalRoles : 0 %></div>
                    <div>Total Roles</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stats-number"><%= stats ? stats.totalUsers : 0 %></div>
                    <div>Total Users</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="stats-number"><%= stats ? stats.activeUsers : 0 %></div>
                    <div>Active Users</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="row">
            <!-- Form Role -->
            <div class="col-lg-5">
                <div class="card shadow-sm p-4 mb-4">
                    <h5 class="mb-4">‚ûï Tambah / Edit Role</h5>
                    <form action="/administrator/insert-role" method="POST" class="form-edit">
                        <input type="hidden" name="_token" value="<%= csrfToken %>">
                        <input type="text" name="_id" class="idInput" hidden/>
                        <input type="hidden" name="editMode" class="editModeInput" value="false" />
                        
                        <div class="mb-3">
                            <label class="form-label">Nama Role</label>
                            <input type="text" name="role" placeholder="Contoh: Administrator" 
                                   class="form-control roleInput" required />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Role ID</label>
                            <input type="number" name="roleId" placeholder="Contoh: 1, 2, 3" 
                                   class="form-control roleIdInput" required />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea rows="2" name="description" placeholder="Deskripsi singkat role" 
                                      class="form-control descriptionInput" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Hak Akses</label>
                            <div class="permission-checkboxes">
                                <div class="form-check mb-2">
                                    <input class="form-check-input postRadio" type="checkbox" 
                                           id="postPermit" name="postPermit" value="1" />
                                    <label class="form-check-label" for="postPermit">
                                        üìä Penilaian Kinerja
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input categoryRadio" type="checkbox" 
                                           id="categoryPermit" name="categoryPermit" value="2" />
                                    <label class="form-check-label" for="categoryPermit">
                                        üìÇ Kategori Instrumen
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input roleRadio" type="checkbox" 
                                           id="rolePermit" name="rolePermit" value="3" />
                                    <label class="form-check-label" for="rolePermit">
                                        üîê Manajemen Role
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input userRadio" type="checkbox" 
                                           id="userPermit" name="userPermit" value="4" />
                                    <label class="form-check-label" for="userPermit">
                                        üë§ Manajemen User
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearInput()">Reset</button>
                            <button class="btn btn-primary" type="submit">üíæ Simpan</button>
                        </div>
                    </form>
                </div>
                
                <!-- User Assignment -->
                <div class="card shadow-sm p-4">
                    <h5 class="mb-3">üë§ Assign Role ke User</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Cari email user..." id="userSearch">
                        <button class="btn btn-outline-primary" type="button" onclick="searchUsers()">Cari</button>
                    </div>
                    <div id="userList">
                        <div class="text-center text-muted py-3">
                            <small>Ketik minimal 2 karakter untuk mencari</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Daftar Role -->
            <div class="col-lg-7">
                <div class="card shadow-sm p-4">
                    <h5 class="mb-4">üìã Daftar Role</h5>
                    
                    <% if (role && role.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Role</th>
                                        <th>Hak Akses</th>
                                        <th>Users</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% role.forEach((r, index) => { %>
                                        <tr>
                                            <td>
                                                <strong><%= r.role %></strong>
                                                <br><small class="text-muted"><%= r.description %></small>
                                            </td>
                                            <td>
                                                <% if (r.permission.includes('1')) { %><span class="badge bg-primary me-1">Penilaian</span><% } %>
                                                <% if (r.permission.includes('2')) { %><span class="badge bg-info me-1">Kategori</span><% } %>
                                                <% if (r.permission.includes('3')) { %><span class="badge bg-warning me-1">Role</span><% } %>
                                                <% if (r.permission.includes('4')) { %><span class="badge bg-success me-1">User</span><% } %>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary" id="count-<%= r.roleId %>">0</span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-warning" onclick="edit('<%= index %>')">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <a href="/delete-role/<%= r.id %>" class="btn btn-sm btn-outline-danger" 
                                                   onclick="return confirm('Yakin hapus role <%= r.role %>?')">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-people" style="font-size: 3rem;"></i>
                            <p class="mt-2">Belum ada role. Buat role pertama di form sebelah.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<div class="data d-none">
    <% if (role) { %>
        <% role.forEach(e => { %>
            <div class="roles">
                <div class="id"><%= e.id %></div>
                <div class="role"><%= e.role %></div>
                <div class="roleId"><%= e.roleId %></div>
                <div class="permission"><%= e.permission %></div>
                <div class="description"><%= e.description %></div>
            </div>
        <% }) %>
    <% } %>
</div>

<!-- Available roles for user assignment -->
<div id="availableRoles" class="d-none" data-roles='<%= JSON.stringify(role ? role.map(r => ({id: r.id, role: r.role, roleId: r.roleId})) : []) %>'></div>
<div id="csrfToken" class="d-none" data-token="<%= csrfToken %>"></div>

<script src="/public/js/toast.js"></script>
<script>
    const inputID = document.querySelector(".idInput");
    const inputRole = document.querySelector(".roleInput");
    const inputRoleID = document.querySelector(".roleIdInput");
    const inputDescription = document.querySelector(".descriptionInput");
    const postRadio = document.querySelector(".postRadio");
    const categoryRadio = document.querySelector(".categoryRadio");
    const roleRadio = document.querySelector(".roleRadio");
    const userRadio = document.querySelector(".userRadio");
    const editModeInput = document.querySelector(".editModeInput");
    const form = document.querySelector(".form-edit");

    function edit(target) {
        const id = document.querySelectorAll(".data .id");
        const role = document.querySelectorAll(".data .role");
        const roleId = document.querySelectorAll(".data .roleId");
        const permission = document.querySelectorAll(".data .permission");
        const description = document.querySelectorAll(".data .description");

        inputID.value = id[target].innerHTML;
        inputRole.value = role[target].innerHTML;
        inputRoleID.value = roleId[target].innerHTML;
        inputDescription.value = description[target].innerHTML;
        editModeInput.value = "true";

        const splitPermit = permission[target].innerHTML.split("");
        postRadio.checked = splitPermit.includes("1");
        categoryRadio.checked = splitPermit.includes("2");
        roleRadio.checked = splitPermit.includes("3");
        userRadio.checked = splitPermit.includes("4");

        form.action = "/administrator/edit-role";
        document.querySelector('.form-edit').scrollIntoView({ behavior: 'smooth' });
        showToast('Mode edit aktif. Ubah data dan klik Simpan.', 'info');
    }

    function clearInput() {
        inputID.value = "";
        inputRole.value = "";
        inputRoleID.value = "";
        inputDescription.value = "";
        postRadio.checked = false;
        categoryRadio.checked = false;
        roleRadio.checked = false;
        userRadio.checked = false;
        editModeInput.value = "false";
        form.action = "/administrator/insert-role";
        showToast('Form direset', 'info');
    }

    async function searchUsers() {
        const query = document.getElementById('userSearch').value;
        if (query.length < 2) {
            showToast('Ketik minimal 2 karakter', 'warning');
            return;
        }

        try {
            const response = await fetch(`/api/rbac/search-users?query=${encodeURIComponent(query)}`);
            const data = await response.json();
            const userList = document.getElementById('userList');
            const roles = JSON.parse(document.getElementById('availableRoles').dataset.roles);
            
            if (data.success && data.users.length > 0) {
                userList.innerHTML = data.users.map(user => `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div>
                            <strong>${user.email}</strong>
                            <br><small class="text-muted">Role: ${user.currentRole ? user.currentRole.name : '-'}</small>
                        </div>
                        <select class="form-select form-select-sm" style="width: 140px;" onchange="assignRole('${user.id}', this.value)">
                            <option value="">Pilih Role</option>
                            ${roles.map(r => `<option value="${r.id}">${r.role}</option>`).join('')}
                        </select>
                    </div>
                `).join('');
                showToast(`Ditemukan ${data.users.length} user`, 'success');
            } else {
                userList.innerHTML = '<div class="text-center text-muted py-3">User tidak ditemukan</div>';
                showToast('User tidak ditemukan', 'warning');
            }
        } catch (error) {
            showToast('Gagal mencari user: ' + error.message, 'error');
        }
    }

    async function assignRole(userId, roleId) {
        if (!roleId) return;
        const csrfToken = document.getElementById('csrfToken').dataset.token;
        
        try {
            const response = await fetch('/api/rbac/assign-role', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({ userId, roleId })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast(data.message, 'success');
                loadRoleStats();
                searchUsers();
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('Gagal assign role: ' + error.message, 'error');
        }
    }

    async function loadRoleStats() {
        try {
            const response = await fetch('/api/rbac/role-stats');
            const data = await response.json();
            if (data.success) {
                data.distribution.forEach(role => {
                    const el = document.getElementById(`count-${role.roleNumId}`);
                    if (el) el.textContent = role.userCount;
                });
            }
        } catch (e) {}
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadRoleStats();
        document.getElementById('userSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchUsers();
        });
    });
</script>
